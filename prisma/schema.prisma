// Devalok Payroll System - Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          UserRole  @default(ADMIN)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // Relations
  createdLokwasis    Lokwasi[]       @relation("CreatedBy")
  createdPayrollRuns PayrollRun[]    @relation("CreatedBy")
  processedPayrollRuns PayrollRun[]  @relation("ProcessedBy")
  createdDebtRuns    DebtRun[]       @relation("DebtRunCreatedBy")
  processedDebtRuns  DebtRun[]       @relation("DebtRunProcessedBy")
  auditLogs          AuditLog[]
  leaveTransactions  LeaveTransaction[]
  settingsUpdates    Setting[]

  @@map("users")
}

enum UserRole {
  ADMIN
  VIEWER
}

// ============================================
// EMPLOYEE (LOKWASI) MANAGEMENT
// ============================================

model Lokwasi {
  id                  String    @id @default(cuid())
  employeeCode        String    @unique @map("employee_code") // e.g., "LW001"
  name                String

  // Sensitive fields (encrypted at application level)
  pan                 String    // PAN format: AAAAA0000A
  aadhaar             String    // 12 digits
  bankAccount         String    @map("bank_account")
  ifscCode            String    @map("ifsc_code") // AAAA0XXXXXX
  bankName            String    @map("bank_name")
  beneficiaryNickname String    @map("beneficiary_nickname") // For bank template
  isAxisBank          Boolean   @default(false) @map("is_axis_bank")

  // Compensation
  tdsRate             Decimal   @default(10) @map("tds_rate") @db.Decimal(5, 2) // Percentage
  grossSalary         Decimal   @map("gross_salary") @db.Decimal(12, 2) // Per pay cycle
  natureOfWork        String    @default("Professional Services") @map("nature_of_work")

  // Leave tracking
  leaveBalance        Decimal   @default(0) @map("leave_balance") @db.Decimal(5, 2) // Days
  initialLeaveBalance Decimal   @default(0) @map("initial_leave_balance") @db.Decimal(5, 2) // Carried from previous year

  // Salary debt (from proprietorship transition)
  salaryDebtBalance   Decimal   @default(0) @map("salary_debt_balance") @db.Decimal(14, 2)

  // Status
  status              LokwasiStatus @default(ACTIVE)
  joinedDate          DateTime  @map("joined_date")
  terminatedDate      DateTime? @map("terminated_date")

  // Metadata
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  createdById         String?   @map("created_by_id")
  createdBy           User?     @relation("CreatedBy", fields: [createdById], references: [id])

  // Relations
  payments            Payment[]
  tdsMonthly          TdsMonthly[]
  leaveTransactions   LeaveTransaction[]
  debtPayments        DebtPayment[]

  @@map("lokwasis")
}

enum LokwasiStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

// ============================================
// PAYROLL PROCESSING
// ============================================

model PayrollRun {
  id              String          @id @default(cuid())
  runDate         DateTime        @map("run_date") // The date payroll was/should be processed
  payPeriodStart  DateTime        @map("pay_period_start")
  payPeriodEnd    DateTime        @map("pay_period_end")
  status          PayrollStatus   @default(PENDING)

  // Totals
  totalGross      Decimal         @default(0) @map("total_gross") @db.Decimal(14, 2)
  totalTds        Decimal         @default(0) @map("total_tds") @db.Decimal(14, 2)
  totalNet        Decimal         @default(0) @map("total_net") @db.Decimal(14, 2)
  totalDebtPayout Decimal         @default(0) @map("total_debt_payout") @db.Decimal(14, 2)
  totalLeaveCashout Decimal       @default(0) @map("total_leave_cashout") @db.Decimal(14, 2)
  employeeCount   Int             @default(0) @map("employee_count")

  notes           String?

  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  processedAt     DateTime?       @map("processed_at")
  paidAt          DateTime?       @map("paid_at")

  // Relations
  createdById     String?         @map("created_by_id")
  createdBy       User?           @relation("CreatedBy", fields: [createdById], references: [id])
  processedById   String?         @map("processed_by_id")
  processedBy     User?           @relation("ProcessedBy", fields: [processedById], references: [id])

  payments        Payment[]

  @@map("payroll_runs")
}

enum PayrollStatus {
  PENDING     // Auto-generated, waiting for admin to review
  DRAFT       // Admin is editing
  PROCESSED   // Excel downloaded, sent to bank
  PAID        // Confirmed paid
  CANCELLED   // Voided
}

model Payment {
  id                  String        @id @default(cuid())
  payrollRunId        String        @map("payroll_run_id")
  payrollRun          PayrollRun    @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  lokwasiId           String        @map("lokwasi_id")
  lokwasi             Lokwasi       @relation(fields: [lokwasiId], references: [id])

  // Financial Details
  grossAmount         Decimal       @map("gross_amount") @db.Decimal(12, 2)
  tdsRate             Decimal       @map("tds_rate") @db.Decimal(5, 2) // Snapshot at time of payment
  tdsAmount           Decimal       @map("tds_amount") @db.Decimal(12, 2)
  leaveCashoutDays    Decimal       @default(0) @map("leave_cashout_days") @db.Decimal(5, 2)
  leaveCashoutAmount  Decimal       @default(0) @map("leave_cashout_amount") @db.Decimal(12, 2)
  debtPayoutAmount    Decimal       @default(0) @map("debt_payout_amount") @db.Decimal(12, 2)
  netAmount           Decimal       @map("net_amount") @db.Decimal(12, 2)

  // Bank Reference
  customerReference   String        @map("customer_reference") // e.g., DVLK-20260130-001

  // Status
  paymentStatus       PaymentStatus @default(PENDING) @map("payment_status")
  paidAt              DateTime?     @map("paid_at")

  // Snapshot of employee data at time of payment (for audit)
  snapshotPan         String        @map("snapshot_pan")
  snapshotAadhaar     String        @map("snapshot_aadhaar")
  snapshotBankAccount String        @map("snapshot_bank_account")
  snapshotIfsc        String        @map("snapshot_ifsc")
  snapshotBankName    String        @map("snapshot_bank_name")
  snapshotIsAxisBank  Boolean       @map("snapshot_is_axis_bank")

  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relations
  leaveTransactions   LeaveTransaction[]
  debtPayments        DebtPayment[]

  @@unique([payrollRunId, lokwasiId])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

// ============================================
// TDS MANAGEMENT
// ============================================

model TdsMonthly {
  id              String      @id @default(cuid())
  year            Int
  month           Int         // 1-12
  lokwasiId       String      @map("lokwasi_id")
  lokwasi         Lokwasi     @relation(fields: [lokwasiId], references: [id])

  // Aggregated from payments
  totalGross      Decimal     @default(0) @map("total_gross") @db.Decimal(14, 2)
  totalTds        Decimal     @default(0) @map("total_tds") @db.Decimal(14, 2)
  totalNet        Decimal     @default(0) @map("total_net") @db.Decimal(14, 2)
  paymentCount    Int         @default(0) @map("payment_count")

  // TDS Filing Status
  filingStatus    TdsFilingStatus @default(PENDING) @map("filing_status")
  interestAmount  Decimal     @default(0) @map("interest_amount") @db.Decimal(10, 2) // If late
  totalTdsPayable Decimal     @default(0) @map("total_tds_payable") @db.Decimal(14, 2) // TDS + interest

  filedDate       DateTime?   @map("filed_date")
  paidDate        DateTime?   @map("paid_date")
  challanNumber   String?     @map("challan_number")

  notes           String?
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@unique([year, month, lokwasiId])
  @@map("tds_monthly")
}

enum TdsFilingStatus {
  PENDING
  WAITING_FOR_FILING
  FILED
  PAID
}

// ============================================
// LEAVE MANAGEMENT
// ============================================

model LeaveTransaction {
  id              String              @id @default(cuid())
  lokwasiId       String              @map("lokwasi_id")
  lokwasi         Lokwasi             @relation(fields: [lokwasiId], references: [id])
  transactionType LeaveTransactionType @map("transaction_type")
  days            Decimal             @db.Decimal(5, 2) // Number of days (positive)
  amount          Decimal             @default(0) @db.Decimal(12, 2) // Total amount for cashout
  leaveYear       Int?                @map("leave_year") // Which year the leave is from (e.g., 2024)
  balanceAfter    Decimal             @map("balance_after") @db.Decimal(5, 2)
  paymentId       String?             @map("payment_id") // If cashout
  payment         Payment?            @relation(fields: [paymentId], references: [id])
  notes           String?
  transactionDate DateTime            @map("transaction_date")
  createdAt       DateTime            @default(now()) @map("created_at")
  createdById     String?             @map("created_by_id")
  createdBy       User?               @relation(fields: [createdById], references: [id])

  @@map("leave_transactions")
}

enum LeaveTransactionType {
  ACCRUAL
  USED
  CASHOUT
  ADJUSTMENT
  CARRYOVER
}

// ============================================
// SALARY DEBT MANAGEMENT
// ============================================

model DebtRun {
  id              String          @id @default(cuid())
  runDate         DateTime        @map("run_date")
  status          DebtRunStatus   @default(PENDING)

  // Totals
  totalGross      Decimal         @default(0) @map("total_gross") @db.Decimal(14, 2)
  totalTds        Decimal         @default(0) @map("total_tds") @db.Decimal(14, 2)
  totalNet        Decimal         @default(0) @map("total_net") @db.Decimal(14, 2)
  employeeCount   Int             @default(0) @map("employee_count")

  notes           String?

  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  processedAt     DateTime?       @map("processed_at")
  paidAt          DateTime?       @map("paid_at")

  // Relations
  createdById     String?         @map("created_by_id")
  createdBy       User?           @relation("DebtRunCreatedBy", fields: [createdById], references: [id])
  processedById   String?         @map("processed_by_id")
  processedBy     User?           @relation("DebtRunProcessedBy", fields: [processedById], references: [id])

  debtPayments    DebtPayment[]

  @@map("debt_runs")
}

enum DebtRunStatus {
  PENDING     // Created, waiting for review
  PROCESSED   // Excel downloaded, sent to bank
  PAID        // Confirmed paid
  CANCELLED   // Voided
}

model DebtPayment {
  id              String          @id @default(cuid())
  lokwasiId       String          @map("lokwasi_id")
  lokwasi         Lokwasi         @relation(fields: [lokwasiId], references: [id])

  // Link to payroll payment (if included in regular payroll)
  paymentId       String?         @map("payment_id")
  payment         Payment?        @relation(fields: [paymentId], references: [id])

  // Link to standalone debt run
  debtRunId       String?         @map("debt_run_id")
  debtRun         DebtRun?        @relation(fields: [debtRunId], references: [id])

  // Financial details
  amount          Decimal         @db.Decimal(12, 2) // Gross debt amount paid/added
  tdsRate         Decimal?        @map("tds_rate") @db.Decimal(5, 2) // TDS rate at time of payment
  tdsAmount       Decimal?        @map("tds_amount") @db.Decimal(12, 2) // TDS deducted
  netAmount       Decimal?        @map("net_amount") @db.Decimal(12, 2) // Amount actually paid (gross - TDS)
  balanceAfter    Decimal         @map("balance_after") @db.Decimal(14, 2)

  source          DebtSource      @default(SALARY) // Source of debt
  sourceYear      Int?            @map("source_year") // Year the debt is from
  isAddition      Boolean         @default(false) @map("is_addition") // true = adding debt, false = paying off
  paymentDate     DateTime        @map("payment_date")
  notes           String?

  // Bank snapshot for standalone debt runs
  customerReference   String?     @map("customer_reference")
  snapshotBankAccount String?     @map("snapshot_bank_account")
  snapshotIfsc        String?     @map("snapshot_ifsc")
  snapshotBankName    String?     @map("snapshot_bank_name")
  snapshotIsAxisBank  Boolean?    @map("snapshot_is_axis_bank")

  createdAt       DateTime        @default(now()) @map("created_at")

  @@map("debt_payments")
}

enum DebtSource {
  SALARY        // Pending salary from proprietorship transition
  LEAVE_CASHOUT // Leave cashout amount owed
  BONUS         // Bonus owed
  OTHER         // Other debt sources
}

// ============================================
// AUDIT & SETTINGS
// ============================================

model AuditLog {
  id          String    @id @default(cuid())
  userId      String?   @map("user_id")
  user        User?     @relation(fields: [userId], references: [id])
  action      String    // 'CREATE_PAYMENT', 'UPDATE_LOKWASI', etc.
  entityType  String    @map("entity_type") // 'payment', 'lokwasi', 'payroll_run', etc.
  entityId    String?   @map("entity_id")
  oldValues   Json?     @map("old_values")
  newValues   Json?     @map("new_values")
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("audit_log")
}

model Setting {
  key         String    @id
  value       Json
  description String?
  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedById String?   @map("updated_by_id")
  updatedBy   User?     @relation(fields: [updatedById], references: [id])

  @@map("settings")
}

// ============================================
// PAYROLL SCHEDULE
// ============================================

model PayrollSchedule {
  id              String    @id @default(cuid())
  lastPayrollDate DateTime  @map("last_payroll_date")
  nextPayrollDate DateTime  @map("next_payroll_date")
  cycleDays       Int       @default(14) @map("cycle_days")
  generationTime  String    @default("09:00") @map("generation_time") // HH:MM format (IST)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("payroll_schedule")
}
